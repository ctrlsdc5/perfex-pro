<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PerfEx Pro | World-Class Performance Suite</title>

<script src="https://cdn.tailwindcss.com"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- FIXED XLSX SCRIPT -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;800&display=swap" rel="stylesheet">

<style>
body { font-family: 'Plus Jakarta Sans', sans-serif; background: #070b14; color: #f8fafc; overflow-x: hidden; }
.glass { background: rgba(17, 24, 39, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
.star-gold { color: #FFD700; text-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
.star-gray { color: #1e293b; }
.nav-active { color: #3b82f6; position: relative; }
.nav-active::after { content: ''; position: absolute; bottom: -4px; width: 12px; height: 3px; background: #3b82f6; border-radius: 10px; }
.btn-bounce:active { transform: scale(0.95); }
@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.animate-slide-up { animation: slideUp 0.4s ease-out forwards; }
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

const { useState, useMemo, useEffect } = React;

/* ================= SUPABASE CONFIG ================= */

const SUPABASE_URL = "YOUR_SUPABASE_URL";
const SUPABASE_KEY = "YOUR_PUBLIC_ANON_KEY";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* =================================================== */

const DEPARTMENTS = ['Electrician','HVAC Operator','BMS Operator'];
const ADMIN_PASS = "Inf0rmati0n@123";

function App() {

const [view,setView] = useState('login');
const [manager,setManager] = useState('');
const [isAdmin,setIsAdmin] = useState(false);
const [activeTab,setActiveTab] = useState('home');
const [passInput,setPassInput] = useState('');
const [showPass,setShowPass] = useState(false);

const [staff,setStaff] = useState([
{ id:1,name:'Arbaj Patel',dept:'Electrician'},
{ id:2,name:'Vishal Palekar',dept:'Electrician'},
{ id:3,name:'Rishabh Dhamne',dept:'HVAC Operator'},
{ id:4,name:'Anurag Singh',dept:'BMS Operator'},
{ id:5,name:'Danish Ansari',dept:'BMS Operator'}
]);

const [ratings,setRatings] = useState([]);
const [selectedDept,setSelectedDept] = useState('Electrician');

/* ========= LOAD FROM SUPABASE ========= */

useEffect(()=>{
loadRatings();
},[]);

async function loadRatings(){
const { data,error } = await supabase.from("ratings").select("*");
if(!error && data){
setRatings(data);
}
}

/* ====================================== */

const rankingData = useMemo(()=>{
return staff.map(s=>{
const staffRatings = ratings.filter(r=>r.empId===s.id);
const avg = staffRatings.length===0?0:
staffRatings.reduce((a,b)=>a+b.avg,0)/staffRatings.length;
return {...s,score:parseFloat(avg.toFixed(2)),ratedBy:staffRatings.length};
}).sort((a,b)=>b.score-a.score);
},[ratings,staff]);

const handleLogin=()=>{
if(isAdmin){
if(passInput===ADMIN_PASS) setView('main');
else alert("Wrong Admin Password!");
}else{
if(manager.trim()) setView('main');
else alert("Please enter manager name");
}
};

const handleLogout=()=>{
if(confirm("Are you sure you want to logout?")){
setView('login');
setManager('');
setPassInput('');
setIsAdmin(false);
setActiveTab('home');
}
};

/* ========= SAVE TO SUPABASE ========= */

async function saveRating(r){
const newRating={...r,date:new Date().toLocaleDateString()};

const { error } = await supabase.from("ratings").insert([newRating]);

if(!error){
setRatings([...ratings,newRating]);
}else{
alert("Error saving rating");
}
}

/* ===================================== */

if(view==='login') return(
<div className="h-screen flex items-center justify-center p-6 bg-[#020617]">
<div className="w-full max-w-sm p-8 rounded-[2.5rem] glass text-center animate-slide-up shadow-2xl">
<h1 className="text-4xl font-black text-blue-500 italic mb-6">PERFEX</h1>

<input type="text" placeholder="Enter Your Name"
className="w-full p-4 bg-slate-900/50 rounded-2xl mb-4 text-white"
onChange={(e)=>setManager(e.target.value)} />

<button onClick={handleLogin}
className="w-full py-4 bg-blue-600 rounded-2xl font-black">
Start Assessment
</button>
</div>
</div>
);

/* ================= MAIN UI ================= */

return(
<div className="min-h-screen bg-[#070b14]">

<header className="p-5 glass sticky top-0 z-50 flex justify-between items-center px-6">
<div>
<div className="font-black text-xl text-blue-500 italic">PERFEX</div>
<div className="text-[8px] font-bold text-slate-500 uppercase">
Connected as {manager}
</div>
</div>
<button onClick={handleLogout}
className="bg-white/5 text-rose-500 p-2 px-4 rounded-xl text-[10px] font-black">
LOGOUT
</button>
</header>

<main className="p-6 pb-40 max-w-md mx-auto space-y-8 animate-slide-up">

{activeTab==='rate' && (
<RatingFlow
staff={staff}
selectedDept={selectedDept}
manager={manager}
ratings={ratings}
onDone={saveRating}
/>
)}

{activeTab==='stats' && (
<div>
{rankingData.map((s,i)=>(
<div key={s.id}
className="glass p-5 rounded-3xl flex justify-between items-center mb-4">
<div>
<div className="font-bold text-lg">{s.name}</div>
<div className="text-xs text-slate-400">{s.dept}</div>
</div>
<div className="text-2xl font-black">{s.score||'---'}</div>
</div>
))}
</div>
)}

</main>

<nav className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] max-w-sm glass rounded-[2.5rem] p-2 flex justify-around z-50">
<button onClick={()=>setActiveTab('rate')} className="flex-1 text-center">RATE</button>
<button onClick={()=>setActiveTab('stats')} className="flex-1 text-center">LEADERBOARD</button>
</nav>

</div>
);
}

/* ================= RATING FLOW ================= */

function RatingFlow({ staff, manager, ratings, onDone }) {

const [emp,setEmp]=useState(staff[0]);
const [vals,setVals]=useState({t:0,c:0,p:0,s:0});

return(
<div className="glass p-8 rounded-[2.5rem]">
<h2 className="text-2xl font-black mb-6">{emp.name}</h2>

<button onClick={()=>{
if(Object.values(vals).some(v=>v===0)) return alert("Rate all fields");

onDone({
manager,
empId:emp.id,
name:emp.name,
dept:emp.dept,
...vals,
avg:(vals.t+vals.c+vals.p+vals.s)/4
});
}}
className="w-full py-5 bg-blue-600 rounded-[2rem] font-black mt-10">
Confirm Rating
</button>

</div>
);
}

const root=ReactDOM.createRoot(document.getElementById('root'));
root.render(<App/>);

</script>
</body>
</html>
