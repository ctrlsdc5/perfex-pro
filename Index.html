<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PerfEx Pro | World-Class Performance Suite</title>

<script src="https://cdn.tailwindcss.com"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const SUPABASE_URL = "https://thjeftenonekovxflzvd.supabase.co";
const SUPABASE_KEY = "sb_publishable_BgdiBx65Zcd-5DTTFRbrjw_lhWluEmu";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
window.supabaseClient = supabase;
</script>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;800&display=swap" rel="stylesheet">

<style>
body { font-family: 'Plus Jakarta Sans', sans-serif; background: #070b14; color: #f8fafc; }
.glass { background: rgba(17, 24, 39, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
.star-gold { color: #FFD700; }
.star-gray { color: #1e293b; }
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

const { useState, useEffect, useMemo } = React;

const DEPARTMENTS = ['Electrician', 'HVAC Operator', 'BMS Operator'];

function App() {

  const [view, setView] = useState("login");
  const [manager, setManager] = useState("");
  const [ratings, setRatings] = useState([]);
  const [staff] = useState([
    { id: 1, name: 'Arbaj Patel', dept: 'Electrician' },
    { id: 2, name: 'Vishal Palekar', dept: 'Electrician' },
    { id: 3, name: 'Rishabh Dhamne', dept: 'HVAC Operator' },
    { id: 4, name: 'Anurag Singh', dept: 'BMS Operator' },
    { id: 5, name: 'Danish Ansari', dept: 'BMS Operator' }
  ]);

  useEffect(() => {
    loadRatings();
  }, []);

  async function loadRatings() {
    const { data } = await window.supabaseClient
      .from("ratings")
      .select("*");
    if (data) setRatings(data);
  }

  async function saveRating(emp, vals) {
    await window.supabaseClient.from("ratings").insert([{
      manager,
      empId: emp.id,
      name: emp.name,
      dept: emp.dept,
      ...vals,
      avg: (vals.t+vals.c+vals.p+vals.s)/4,
      date: new Date().toLocaleDateString()
    }]);
    loadRatings();
  }

  const rankingData = useMemo(() => {
    return staff.map(s => {
      const empRatings = ratings.filter(r => r.empId === s.id);
      const avg = empRatings.length === 0 ? 0 :
        empRatings.reduce((a,b)=>a+b.avg,0)/empRatings.length;
      return { ...s, score: avg.toFixed(2) };
    }).sort((a,b)=>b.score - a.score);
  }, [ratings]);

  if(view==="login") return (
    <div className="h-screen flex justify-center items-center">
      <div className="glass p-10 rounded-3xl text-center">
        <h1 className="text-3xl font-bold mb-6">PERFEX PRO</h1>
        <input className="p-3 text-black rounded"
          placeholder="Manager Name"
          onChange={(e)=>setManager(e.target.value)}
        />
        <button onClick={()=>manager?setView("main"):alert("Enter name")}
          className="bg-blue-600 px-6 py-3 rounded mt-5">
          Enter
        </button>
      </div>
    </div>
  );

  return (
    <div className="p-10 space-y-10 max-w-xl mx-auto">
      <h2 className="text-2xl font-bold text-center">
        Welcome {manager}
      </h2>

      <div className="space-y-6">
        {staff.map(emp=>(
          <RatingCard key={emp.id}
            emp={emp}
            onSave={(vals)=>saveRating(emp,vals)}
          />
        ))}
      </div>

      <div>
        <h3 className="text-xl font-bold mt-10 mb-4">Leaderboard</h3>
        {rankingData.map((s,i)=>(
          <div key={i} className="glass p-4 rounded mb-2 flex justify-between">
            <span>{s.name}</span>
            <span>{s.score} ⭐</span>
          </div>
        ))}
      </div>
    </div>
  );
}

function RatingCard({ emp, onSave }) {

  const [vals, setVals] = useState({t:0,c:0,p:0,s:0});

  return (
    <div className="glass p-6 rounded-3xl">
      <h4 className="text-lg font-bold mb-4">{emp.name}</h4>

      {["t","c","p","s"].map(k=>(
        <div key={k} className="flex gap-2 mb-3">
          {[1,2,3,4,5].map(n=>(
            <button key={n}
              onClick={()=>setVals({...vals,[k]:n})}
              className={vals[k]>=n?"star-gold":"star-gray"}>
              ★
            </button>
          ))}
        </div>
      ))}

      <button
        onClick={()=>{
          if(Object.values(vals).includes(0))
            return alert("Rate all!");
          onSave(vals);
          setVals({t:0,c:0,p:0,s:0});
        }}
        className="bg-blue-600 px-4 py-2 rounded mt-3">
        Save Rating
      </button>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);

</script>
</body>
</html>
